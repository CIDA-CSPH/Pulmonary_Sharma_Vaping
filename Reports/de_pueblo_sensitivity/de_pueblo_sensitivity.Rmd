---
title: 'Sensitivity Analysis for Pueblo'
author: |
 | Project: `r CIDAtools::ProjectName()`
 |
 | Analyst: `r CIDAtools::ProjectAnalyst()`
 |
 | Investigator(s): `r CIDAtools::ProjectPI()`
 |
 | Report generated: `r paste(format(Sys.Date(), '%B %d, %Y'))`
output:
  html_document:
    highlight: espresso
    number_sections: no
    theme: yeti
    toc: yes
    toc_depth: 2
    toc_float: yes
    code_folding: hide
---

```{r, echo=FALSE, out.width='70%', fig.show='hold'}
logo <- system.file("figures", "sph_cida_wm_blk.png", package="CIDAtools")
knitr::include_graphics(logo)
```

------------------------------------------------------------------------

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = F, warning = F, error = F)
library(ggpubr)
library(tidyverse)
library(knitr)
library(kableExtra)
library(DESeq2)
library(here)
library(RColorBrewer)


#############Table Version of Venn Diagram##################
kablize <- function(tab, digits = 3) {
  kable(tab,digits = digits, booktabs = T) %>% 
  kableExtra::kable_styling(latex_options = c("hold_position", "striped"), position = "center")
}

format_num <- function(number, digits = 0) {
  formatC(number, digits = digits, format = "f", big.mark = ",")
}
```

# Introduction

The overall breakdown of study participants shows that 12 of the 13 (92%) of vapers recruited for this study were from the Pueblo center; however, the pueblo center accounts for only 42% of the study population. The purpose of this report is to look at an analysis of only the participants recruited from the Pueblo center and compare it to the overall model to ensure that RUVr normalization is appropriately adjusting for this correlation. 

# Methods

To assess the difference in model outputs, the following model was fit in DESeq2 `r package.version("DESeq2")` with all of the recruited subjects and again with only the subjects from the Pueblo recruitment center. Likelihood Ratio Tests (LRTs) were implemented to test for gene significance and corrected with FDR = 0.05. For the purpose of this report, the model containing all subjects will be referred to as *Model A* and the model with only participants from the Pueblo recruitment center will be referred to as *Model P*.

$$Full \ Model \\ raw \ read \ count \sim vape \ status + recruitment \ center + sex + age + ruv_1 + ruv_2$$

$$Reduced \ Model \ (Vape \ Status) \\ raw \ read \ count \sim recruitment \ center + sex + age + ruv_1 + ruv_2$$

When fitting the model for only the subjects recruited in pueblo, the *recruitment center* covariate is held constant, and therefore, not included in the model. Each of these models will test if *vape status* contributes significantly to gene expression.  

To assess the difference in the models, the results will focus on genes with relatively low variability. To achieve a stable subset, a cutoff value of |Log~2~(Fold-Change)| > 2 will be used (see "sample12_sensitivity_report" for details). This report will present:\
<br/>

1.  A Venn Diagram summarizing the top 100 genes in each model.\
    <br/>
2.  Visualizations comparing |Log~2~(Fold-Change)| estimates and p-values between the two models.\
    <br/>
3.  A short table for the top 10 genes and their estimates in both models.

# Results

The top 100 genes determined by the FDR-adjusted p-value were subset from Model A to compare to Model B. This comparison shows that the top 100 genes in Model A are identical to the top 100 genes in Model B. Some of these genes have very small estimates, which may lead to an extremely large % change, even if the actual amount of change is relatively small. To find a more stable subset of genes, Figure 1 presents a range of possible cutoff values and how many genes in the top 100 are replaced compared to a model with no cutoff.

```{r fig.width=12}
#############Read in results###################
modA_res <- read_csv(here("DataProcessed/de_full/full_vape_res_2022_05_01.csv"))
modB_res <- read_csv(here("DataProcessed/de_pueblo_sensitivity/vape_res_pblo_2022_06_13.csv"))

#############Join results and get top 100 genes###################
AB_res <- left_join(modA_res, modB_res, by = c("ensg", "gene_name", "gene_type"), suffix = c(".modA", ".modB"))
#no cutoff
top_100_genes_AB <- AB_res %>% arrange(padj.modA) %>% .[1:100,]

######################### Filter for log-fold change (check) ###############################
AB_res <- AB_res %>% 
  filter(abs(log2FoldChange.modA) > 2) %>% 
  arrange(padj.modA)

#Make Tidy Results
cutoff_100_res <- cutoff_100 %>% 
  dplyr::mutate(fold_change_diff = log2FoldChange.modB - log2FoldChange.modA,
                fold_change_diff_p = (log2FoldChange.modB - log2FoldChange.modA)/log2FoldChange.modA) %>% 
  dplyr::select(ensg, gene_name, gene_type, log2FoldChange.modA, log2FoldChange.modB, fold_change_diff, fold_change_diff_p, padj.modA, padj.modB) %>% 
  dplyr::rename(Gene = ensg,
                Gene_Name = gene_name,
                Gene_Type = gene_type,
                Estimate_A = log2FoldChange.modA,
                Estimate_B = log2FoldChange.modB,
                Estimate_Difference = fold_change_diff,
                FDR_A = padj.modA,
                FDR_B = padj.modB)
```

Figure 1 shows A) the number of genes removed from all significant genes in Model A and B) the number of genes that change in the subset of the top 100 genes. It should be noted that those genes are still significant, but not included in the range of the cutoff demonstrated. In the interest of obtaining a smaller subset of genes to work with, we will use a cutoff of an |Log~2~(Fold-Change)| of 2. At this cutoff value,  `r format_num(as.numeric(sample_12_cutoff[9,2]), 0)` genes remain in the overall results from Model A, and `r format_num(as.numeric(sample_12_cutoff[9,3]), 0)` genes changed in the composition of the top 100 genes.

```{r}




# #############Venn Diagram##################
# #Get significant pvals
# pval_match <- AB_res_cutoff %>% 
#   dplyr::mutate(modA_sig = if_else(FDR_A < 0.05 & FDR_B > 0.05, T,F),
#                 modB_sig = if_else(FDR_B < 0.05 & FDR_A > 0.05, T,F),
#                 modAB_sig = if_else(FDR_B < 0.05 & FDR_A < 0.05, T,F),
#                 neither_sig = if_else(FDR_A > 0.05 & FDR_B > 0.05,T, F)) %>% 
#   dplyr::arrange(FDR_A)
# 
# cutoff_100 <- pval_match[1:100,]
# 
# #Get significant gene names for each model
# modA_sig_genes <- pval_match[pval_match$FDR_A < 0.05,]$Gene
# modB_sig_genes <- pval_match[pval_match$FDR_B < 0.05,]$Gene
# 
# #Set color palatte
# venn_color <- brewer.pal(3,"Pastel2")
# 
# Make Venn Diagram
# VennDiagram::venn.diagram(x = list(modA_sig_genes,modB_sig_genes),
#                           category.names = c("Model A","Model B"),
#                           filename = here("Reports/figures/venn_diagrams/sample12_sens_venn.png"),
#                           lwd = 2,
#                           fill = c(venn_color[1],venn_color[3]))
```

### Figure 2: Total Significant Genes in Models A & B

The top 100 significant genes in models A & B are identical both before and after the selected cutoff value (|Log~2~(Fold-Change)| > 2). A Venn Diagram of these would be trivial (a single circle), so Figure 2 shows the breakdown of the significant genes in Models A and B.  

![](/Users/hawkjona/Library/CloudStorage/OneDrive-TheUniversityofColoradoDenver/CIDA/Sharma_Vape_Local/figures/sample12_sens_venn.jpg)
One feature that is not yet understood is that there are a large number of significant genes in both models (>6000). Figure 3 displays A) Log~2~(Fold-Change) from each model plotted against each other; B & C) histograms of the difference in Log~2~(Fold-Change) estimates by subtracting the estimate of Model B from the estimate from Model A. 

### Figure 3: Difference in Log~2~(Fold-Change) (Top 100 Genes)

```{r fig.height=8, fig.width=10}
#############Plots of change in log2fc##################
#Scatter Plot
change_scatter <- cutoff_100_res %>% 
  ggplot(aes(x = Estimate_A, y = Estimate_B)) +
  geom_point(col = case_when(cutoff_100_res$Estimate_A > 0 & cutoff_100_res$Estimate_B < 0 ~ 'red',
                             cutoff_100_res$Estimate_A < 0 & cutoff_100_res$Estimate_B > 0 ~ 'red',
                             TRUE ~ 'black')) +
  geom_abline(intercept = 0, slope = 1, linetype = 2, col = 'red')+
  labs(x = "Estimate (Model A)",
       y = "Estimate (Model B)",
       title = "A")

#Histogram of difference
diff_hist <- cutoff_100_res %>% 
  ggplot(aes(x = Estimate_Difference)) +
  geom_histogram(col = 'white', binwidth = 0.25) +
  scale_x_continuous(breaks = seq(-1.5, 1.5, 0.5)) +
  geom_vline(xintercept = 0, linetype = 2, col = 'red') +
  labs(x = "Difference",
       y = "Count",
       title = "B")

#Histogram of % change
p_diff_hist <- cutoff_100_res %>% 
  ggplot(aes(x = fold_change_diff_p)) +
  geom_histogram(col = 'white', binwidth = 0.1) +
  scale_x_continuous(breaks = seq(-1, 1, 0.25)) +
  geom_vline(xintercept = 0, linetype = 2, col = 'red') +
  labs(x = "Difference (%)",
       y = "Count",
       title = "C")

ggarrange(change_scatter, ggarrange(diff_hist, p_diff_hist, ncol = 2, nrow = 1, legend = "none"), nrow = 2, common.legend = T, legend = "bottom")
```

*Table 2: Top 10 Significant Genes Models A & B*

```{r}
cutoff_100_res[1:10,] %>% 
  mutate(fold_change_diff_p = fold_change_diff_p*100) %>% 
  select(Gene, Gene_Name, Gene_Type, Estimate_A, Estimate_B, Estimate_Difference, fold_change_diff_p, FDR_A, FDR_B) %>% 
  mutate(FDR_A = if_else(FDR_A < 0.001, "< 0.001", as.character(round(FDR_A,3))),
         FDR_B = if_else(FDR_B < 0.001, "< 0.001", as.character(round(FDR_B,3)))) %>% 
  dplyr::rename("Ensemble ID" = Gene,
                "Gene Name" = Gene_Name,
                "Gene Type" = Gene_Type,
                "Estimate (Mod A)" = Estimate_A,
                "Estimate (Mod B)" = Estimate_B,
                "Estimate Difference" = Estimate_Difference,
                "Esimate Difference (%)" = fold_change_diff_p,
                "FDR (Mod A)" = FDR_A,
                "FDR (Mod B)" = FDR_B) %>% 
  kablize(.,digits = 3)
```
These results demonstrate that Sample 12 has a down-regulating effect on gene expression. That effect does not make a large difference in the number of significant genes or the direction of their effect. Figure 4 parallels Plot A in Figure 3, but includes the top 2000 genes to visualize this trend. 

### Figure 4: Figure 3: Difference in Log~2~(Fold-Change) (Top 2000 Genes)
```{r}
#Get the top 2000 genes
top_1000 <- AB_res[1:1000,]

#Make Tidy Results
res_1000 <- top_1000 %>% 
  dplyr::mutate(fold_change_diff = log2FoldChange.modB - log2FoldChange.modA,
                fold_change_diff_p = (log2FoldChange.modB - log2FoldChange.modA)/log2FoldChange.modA) %>% 
  dplyr::select(ensg, gene_name, gene_type, log2FoldChange.modA, log2FoldChange.modB, fold_change_diff, fold_change_diff_p, padj.modA, padj.modB) %>% 
  dplyr::rename(Gene = ensg,
                Gene_Name = gene_name,
                Gene_Type = gene_type,
                Estimate_A = log2FoldChange.modA,
                Estimate_B = log2FoldChange.modB,
                Estimate_Difference = fold_change_diff,
                FDR_A = padj.modA,
                FDR_B = padj.modB)

#Scatter Plot
change_scatter <- res_1000 %>% 
  ggplot(aes(x = Estimate_A, y = Estimate_B)) +
  geom_point() +
  geom_abline(aes(intercept = 0, slope = 1, col = "A = B"), linetype = 2)+
  labs(x = "Estimate (Model A)",
       y = "Estimate (Model B)",
       title = "A")+
  scale_x_continuous(breaks = seq(-10,10,2)) +
  scale_y_continuous(breaks = seq(-10,10,2)) +
  scale_color_manual(name = "Guides", values = c("A = B" = "red"))
change_scatter
```

Figure 5 similarly visualizes the trend by plotting -log~10~(p-value) for each of the models plotted against each other.

### Figure 5: -log~10~(p-value) Model A vs. Model B
```{r}
top_1000 %>% 
  ggplot(aes(x = -log10(padj.modA), y = -log10(padj.modB))) +
  geom_point() +
  geom_abline(aes(intercept = 0, slope = 1, col = 'A = B'), linetype = 2)+
  scale_color_manual(name = "Guides", values = c("A = B" = "red")) +
  labs(x = "-log10(p-value A)",
       y = "-log10(p-value B)")
```


# Conclusion

When looking at only the top 100 genes as determined by FDR-adjusted P-values, all genes retain significance from Model A to Model B. From the series of visualizations presented in the report, Sample 12 down-regulates gene expression overall, but does not significantly change the composition of significantly expressed genes. Sample 12 will be kept for further analyses to additionally help maintain power; however, it's role in down-regulating gene expression should be considered. 

 <!-- footer -->

------------------------------------------------------------------------

```{r, echo=FALSE, out.width='70%', fig.show='hold'}
knitr::include_graphics(logo)
```
