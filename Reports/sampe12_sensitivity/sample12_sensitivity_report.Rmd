---
title: Sensitivity Analysis for Sample 12
author: |
 | Project: `r CIDAtools::ProjectName()`
 |
 | Analyst: `r CIDAtools::ProjectAnalyst()`
 |
 | Investigator(s): `r CIDAtools::ProjectPI()`
 |
 | Report generated: `r paste(format(Sys.Date(), '%B %d, %Y'))`
output:
  html_document:
    highlight: espresso
    number_sections: no
    theme: yeti
    toc: yes
    toc_depth: 2
    toc_float: yes
    code_folding: hide
---

```{r, echo=FALSE, out.width='70%', fig.show='hold'}
logo <- system.file("figures", "sph_cida_wm_blk.png", package="CIDAtools")
knitr::include_graphics(logo)
```

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = F, warning = F, error = F)
library(ggpubr)
library(tidyverse)
library(knitr)
library(kableExtra)
library(DESeq2)
library(here)
library(RColorBrewer)
```

# Introduction

In the generalized results report, it appeared that Sample 12 may not have been sufficiently corrected by the DESeq2 model as suggested by the RLE and PCA plots produced by RUVSeq (see "Exploratory Report" and "Differential Expression Results"). This short report will perform a sensitivity analysis for Sample 12 and compare the results for the model *Vape Status* with results when Sample 12 is removed from the model.  

# Methods

To assess the difference in model outputs, the following model was fit in DESeq2 `r package.version("DESeq2")` both with and without Sample 12. Likelihood Ratio Tests (LRTs) were implemented to test for gene significance and corrected with FDR = 0.05. For the purpose of this report, the model containing Sample 12 will be referred to as *Model A* and the model with sample 12 removed will be referred to as *Model B*.    

$$Full \ Model \\ raw \ read \ count \sim vape \ status + recruitment \ center + sex + age + ruv_1 + ruv_2$$

$$Reduced \ Model \ (Vape \ Status) \\ raw \ read \ count \sim recruitment \ center + sex + age + ruv_1 + ruv_2$$  
To assess the difference in the models, the results will present:  
  1. A Venn Diagram summarizing the number of significant genes in each model.  
  2. Tables comparing Log2(Fold-Change) estimates between the two models for the top 10 genes in Model A.  
  3. Histograms showing the distributions of estimates for Log2(Fold-Change) and the change in estimates between models for the top 10 genes in Model A.  
  
# Results  
## Top 100 genes from Model A compared to Model B

The top 100 genes determined by the FDR-adjusted p-value were subset from Model A to compare to Model B. This comparison shows that the top 100 genes in Model A are identical to the top 100 genes in Model B when subset in this manner. A venn diagram of this would be trivial (a single circle), so Figure 1 shows the overlap in significant genes between Models A & B. Table 1 shows that all top 100 genes are the same between Model A and B when sorted by adjusted p-values.   
```{r}
#############Read in results###################
modA_res <- read_csv(here("DataProcessed/sample12_sensitivity/Vape_Results_With_12_2022_05_11.csv"))
modB_res <- read_csv(here("DataProcessed/sample12_sensitivity/Vape_Results_no12_2022_05_11.csv"))
gene_annotations <- read_tsv(here("DataRaw/gencode_annotations.txt"))

#join all results
AB_res <- left_join(modA_res, modB_res, by = "row", suffix = c(".modA", ".modB"))

AB_res <- left_join(AB_res, gene_annotations, by = c("row" = "ENSG"))

top_100_genes_AB <- AB_res %>% arrange(padj.modA) %>% .[1:100,]

#Make Tidy Results
AB_res <- AB_res %>% 
  dplyr::mutate(fold_change_diff = log2FoldChange.modA - log2FoldChange.modB) %>% 
  dplyr::select(row, symbol, gene_type, log2FoldChange.modA, log2FoldChange.modB, fold_change_diff, padj.modA, padj.modB) %>% 
  dplyr::rename(Gene = row,
                Estimate_A = log2FoldChange.modA,
                Estimate_B = log2FoldChange.modB,
                Estimate_Difference = fold_change_diff,
                FDR_A = padj.modA,
                FDR_B = padj.modB)

#Get significant pvals
pval_match <- AB_res %>% 
  dplyr::mutate(modA_sig = if_else(FDR_A < 0.05 & FDR_B > 0.05, T,F),
                modB_sig = if_else(FDR_B < 0.05 & FDR_A > 0.05, T,F),
                modAB_sig = if_else(FDR_B < 0.05 & FDR_A < 0.05, T,F),
                neither_sig = if_else(FDR_A > 0.05 & FDR_B > 0.05,T, F)) %>% 
  dplyr::arrange(FDR_A)

top_100_genes_AB <- pval_match[1:100,]

#############Venn Diagram##################

#Get significant gene names for each model
modA_sig_genes <- pval_match[pval_match$FDR_A < 0.05,]$Gene
modB_sig_genes <- pval_match[pval_match$FDR_B < 0.05,]$Gene

#Set color palatte
venn_color <- brewer.pal(3,"Pastel2")

#Make Venn Diagram
# VennDiagram::venn.diagram(x = list(modA_sig_genes,modB_sig_genes),
#                           category.names = c("Model A","Model B"),
#                           filename = here("Reports/figures/venn_diagrams/sample12_sens_venn.png"),
#                           lwd = 2,
#                           fill = c(venn_color[1],venn_color[3]))
```

### Figure 1: Total Significant Genes in Models A & B
![](/Users/hawkjona/Library/CloudStorage/OneDrive-TheUniversityofColoradoDenver/CIDA/Sharma_Vape_Local/figures/sample12_sens_venn.jpg)
*Table 1: Significant Genes Sorted by FDR-adjusted P-Value*  
```{r}
#############Table Version of Venn Diagram##################
kablize <- function(tab, digits = 3) {
  kable(tab,digits = digits, booktabs = T) %>% 
  kableExtra::kable_styling(latex_options = c("hold_position", "striped"), position = "center")
}

format_num <- function(number, digits = 0) {
  formatC(number, digits = digits, format = "f", big.mark = ",")
}

tibble("Model(s) of Significance" = c("Model A", "Model B", "Model A & B", "Neither"),
       "Top 100 Unique Genes (FDR < 0.05)" = c(format_num(sum(top_100_genes_AB$modA_sig)),
                                               format_num(sum(top_100_genes_AB$modB_sig)),
                                               format_num(sum(top_100_genes_AB$modAB_sig)),
                                               format_num(sum(top_100_genes_AB$neither_sig))),
       "Total Unique Genes (FDR < 0.05)" = c(format_num(sum(pval_match$modA_sig)),
                        format_num(sum(pval_match$modB_sig)),
                        format_num(sum(pval_match$modAB_sig)),
                        format_num(sum(pval_match$neither_sig)))) %>% 
         kablize(digits = 0)
```

### Figure 2: Distribution of Estimates for Top 100 Genes
```{r fig.height=6, fig.width=10}
#############Histograms##################

modelA_estimates <- top_100_genes_AB %>% 
  ggplot(aes(x = Estimate_A)) +
  geom_histogram(binwidth = 0.5, color = "white") +
  labs(x = "Model A Estimates",
       y = "Counts")

modelB_esimates <- top_100_genes_AB %>% 
  ggplot(aes(x = Estimate_B)) +
  geom_histogram(binwidth = 0.5, color = "white") +
  labs(x = "Model B Estimates",
       y = "")

estimates_diff <- top_100_genes_AB %>% 
  ggplot(aes(x = Estimate_Difference)) +
  geom_histogram(binwidth = 0.25, color = "white") +
  geom_vline(xintercept = 0, linetype = "dashed", col = "red") +
  labs(x = "Change in Estimates (Model A - Model B)",
       y = "")

ggarrange(modelA_estimates, modelB_esimates, estimates_diff, nrow = 1)
```

Figure 2 shows that the distribution of estimates for the top 100 genes are approximately the same in Models A and B.  

*Table 2: Top 10 Significant Genes Models A & B* 
```{r}
top_100_genes_AB[1:10,] %>% 
  select(Gene, symbol, gene_type, Estimate_A, Estimate_B, Estimate_Difference, FDR_A, FDR_B) %>% 
  mutate(FDR_A = if_else(FDR_A < 0.001, "< 0.001", as.character(round(FDR_A,3))),
         FDR_B = if_else(FDR_B < 0.001, "< 0.001", as.character(round(FDR_B,3)))) %>% 
  dplyr::rename("Ensemble ID" = Gene,
                "Gene Name" = symbol,
                "Gene Type" = gene_type,
                "Estimate (Mod A)" = Estimate_A,
                "Estimate (Mod B)" = Estimate_B,
                "Estimate Difference" = Estimate_Difference,
                "FDR (Mod A)" = FDR_A,
                "FDR (Mod B)" = FDR_B) %>% 
  kablize(.,digits = 3)
```

## Top 100 Genes Sorted by Estimate Difference from Model A to Model B

Perhaps a more interesting comparison is to look at the genes which changed the *most* from Model A to Model B. $\log_2(FoldChange)_{A} - \log_2(FoldChange)_{B}$ gives the difference in estimates between the models.  
```{r}
#############Table for change in estimates##################
top_100_change <- AB_res %>% 
  arrange(Estimate_Difference) %>% 
  .[1:100,]

#############Venn Diagram##################
venn2_color <- brewer.pal(3,"Pastel1")
modA_sig_change <- top_100_change[top_100_change$FDR_A < 0.05,]$Gene
modB_sig_change <- top_100_change[top_100_change$FDR_B < 0.05,]$Gene

#Make Venn Diagram
# VennDiagram::venn.diagram(x = list(modA_sig_change,modB_sig_change),
#                           category.names = c("Model A","Model B"),
#                           filename = here("Reports/figures/venn_diagrams/sample12_sens_venn_top100_change.png"),
#                           lwd = 2,
#                           fill = c(venn2_color[1],venn2_color[2]))
```
### Figure 3: Significant Genes for Top 100 Genes Sorted by Change in Estimate  
![](/Users/hawkjona/Library/CloudStorage/OneDrive-TheUniversityofColoradoDenver/CIDA/Sharma_Vape_Local/figures/sample12_sens_venn_top100_change.jpg)
*Table 3: Significant Genes Sorted by Change in Estimate*  
```{r}
#############Table Version of Venn Diagram##################
#Subset top 100 genes by estimate difference
pval_diff_sort <- pval_match %>% arrange(Estimate_Difference)
pval_diff_sort_100 <- pval_match %>% arrange(Estimate_Difference) %>% .[1:100,]

#make nice table
tibble("Model(s) of Significance" = c("Model A", "Model B", "Model A & B", "Neither"),
       "Top 100 (FDR < 0.05)" = c(format_num(sum(pval_diff_sort_100$modA_sig)),
                        format_num(sum(pval_diff_sort_100$modB_sig)),
                        format_num(sum(pval_diff_sort_100$modAB_sig)),
                        format_num(sum(pval_diff_sort_100$neither_sig))),
       "Total (FDR < 0.05)" = c(format_num(sum(pval_diff_sort$modA_sig)),
                        format_num(sum(pval_diff_sort$modB_sig)),
                        format_num(sum(pval_diff_sort$modAB_sig)),
                        format_num(sum(pval_diff_sort$neither_sig)))) %>% 
         kablize(digits = 0)

```

Of the top 100 genes determined by change in estimate, 1 retained significance in only Model A, 22 retained significance in both models, 19 gained significance in only Model B, and 58 were not significant in either model.

### Figure 4: Distribution of Top 100 Estimates sorted by Estimate Difference  
The

```{r fig.height=6, fig.width=10}
#############Histograms##################

modelA_estimates <- top_100_change %>% 
  ggplot(aes(x = Estimate_A)) +
  geom_histogram(binwidth = 5, color = "white") +
  labs(x = "Model A Estimates",
       y = "Counts")

modelB_esimates <- top_100_change %>% 
  ggplot(aes(x = Estimate_B)) +
  geom_histogram(binwidth = 5, color = "white") +
  labs(x = "Model B Estimates",
       y = "")

estimates_diff <- top_100_change %>% 
  ggplot(aes(x = Estimate_Difference)) +
  geom_histogram(binwidth = 1, color = "white") +
  geom_vline(xintercept = 0, linetype = "dashed", col = "red") +
  labs(x = "Change in Estimates (Model A - Model B)",
       y = "")

ggarrange(modelA_estimates, modelB_esimates, estimates_diff, nrow = 1)
```

Figure 4 shows that of the top 100 genes which had the largest change in estimates, all estimates decreased by approximately 2 to 8 units in $log_2$(Fold-Change). Table 4 gives the top 10 genes which changed the most from Model A to Model B.

*Table 4: Top 10 Most Changed Genes*  
```{r}
pval_diff_sort[1:10,] %>% 
  mutate(gene_sig_change = if_else(modB_sig == T, "Yes", "No")) %>% 
  select(Gene, symbol, gene_type, Estimate_A, Estimate_B, Estimate_Difference, FDR_A, FDR_B, gene_sig_change) %>% 
  dplyr::rename("Ensemble ID" = Gene,
                "Gene Name" = symbol,
                "Gene Type" = gene_type,
                "Estimate (Mod A)" = Estimate_A,
                "Estimate (Mod B)" = Estimate_B,
                "Estimate Difference" = Estimate_Difference,
                "FDR (Mod A)" = FDR_A,
                "FDR (Mod B)" = FDR_B,
                "Significance Change" = gene_sig_change) %>% 
  kablize(.,digits = 3)
```


# Conclusion  

When looking at only the top 100 genes as determined by FDR-adjusted P-values, all genes retain significance from Model A to Model B and estimates in $log_2$(Fold-Change) differ by about 1 unit in either direction. The differences are largely centered around 0 indicating that the overall difference is not great.  

Conversely, when looking at the top 100 genes as determined by difference in $log_2$(Fold-Change) estimates from Model A to Model B, estimates have a trend to *decrease* by approximately 2 to 8 units. Additionally, the significance status of some of these genes changes from Model A to Model B
<!-- footer -->

---

```{r, echo=FALSE, out.width='70%', fig.show='hold'}
knitr::include_graphics(logo)
```

